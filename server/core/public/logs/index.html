<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API</title>
    <style>
        *,
        *::before,
        *::after {
            color-scheme: dark;
            line-height: 1.5;
            box-sizing: border-box;
            font: inherit;
            font-family: monospace;
            color: inherit;
            border: none;
            outline: none;
            line-height: inherit;
        }

        html {
            height: 100%;
            width: 100%;
            color-scheme: dark;
            /* Prevent scroll for mobile */
            overflow: hidden;
            position: fixed;
        }

        body {
            padding: 1rem;
            font-size: 14px;
            background-color: black;
            color: #CCC;
        }

        button,
        input {
            padding: .5rem;
            border-radius: .25rem;
            background-color: #333;
            color: #CCC;
        }

        body {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        main {
            flex-grow: 1;
            overflow: auto;
            border: 1px solid #333;
            padding: .5rem;
        }

        h2 {
            margin-top: 0;
            font-size: 2rem;
        }

        a {
            color: hsl(200, 99%, 65%);
            text-decoration: none;
            cursor: pointer;
        }

        pre {
            margin: 0;
            padding: .2rem;
            font-size: smaller;
        }

        pre:hover {
            background-color: #333;
            color: #eee;
        }
    </style>
    <script>

        // Helper Functions
        function log(...params) { if (false) console.log(...params) }
        function err(...params) { if (true) console.error(...params) }

        // Build URL
        function buildURL(path, options = {}) {
            const ip = options.ip ?? document.location.hostname
            const port = options.port ?? document.location.port
            const protocol = options.protocol ?? document.location.protocol
            const host = options.protocol === 'https:' ? `${ip}` : `${ip}:${port}`
            return `${protocol}//${host}${path}`
        }

        // GET JSON response
        async function getJSON(path, options = {}) {

            // URL
            const url = buildURL(path, options)
            log(`get(${url})`)

            // Fetch options
            const token = localStorage.getItem('token') ?? ""
            const fetch_options = {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            }

            // Fetch
            try {
                const response = await fetch(url, fetch_options)
                log(`get(${url})`, response)

                // Parse JSON
                try {
                    const json = await response.json()
                    return json
                }
                catch (error) {
                    err(`get(${url})`, "response not a json")
                    return "not a json"
                }
            }

            // Errors
            catch (error) { return err(error) }

        }

        // POST JSON and JSON response
        async function postJSON(path, body, options = {}) {

            // URL
            const url = buildURL(path, options)
            log(`postJSON(${url}, ...)`, body)

            // Fetch options
            const token = localStorage.getItem('token') ?? ""
            const fetch_options = {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(body)
            }

            // Fetch
            try {
                const response = await fetch(url, fetch_options)
                log(`postJSON(${url}, ...)`, response)

                // Parse JSON
                try {
                    const json = await response.json()
                    return json
                }
                catch (error) {
                    err(`postJSON(${url}, ...)`, "response not a json")
                    return "not a json"
                }
            }

            // Errors
            catch (error) { return err(error) }

        }

        // Login
        async function login(username, password, options = {}) {

            // Send username and password to login endpoint
            const token = await postJSON("/api/user/get-token", {
                username: username,
                password: password
            }, options)

            // error
            if (token.startsWith("error")) {
                await logout()
                return token
            }

            // Save Token to localStorage
            else {
                log("token saved")
                await localStorage.setItem("token", token)
                return token
            }

        }

        // Logout
        async function logout() {
            localStorage.removeItem("token")
        }

        async function loadLogs(files) {
            const logElement = document.getElementById('logs')
            const prettifyElement = document.getElementById("prettify")
            const debugElement = document.getElementById("debug")
            const infoElement = document.getElementById("info")
            const filterElement = document.getElementById("filter")
            const file = await postJSON("/api/logger/file", { file: files[files.length - 1] })
            logElement.innerHTML = ""
            const split = file.split("\n")
            split.pop()
            const logLines = []
            for (let i = 0; i < split.length; i++) {
                const line = split[split.length - 1 - i]
                const obj = JSON.parse(line)
                try { logLines.push(obj) }
                catch (error) { console.error("line", line) }

                if (obj.message.includes("api/logger")) { }
                else if (filterElement.value && !(
                    obj.group.toLowerCase().includes(filterElement.value.toLowerCase()) ||
                    obj.message.toLowerCase().includes(filterElement.value.toLowerCase()) ||
                    JSON.stringify(obj.obj).toLowerCase().includes(filterElement.value.toLowerCase())
                )) { }
                else if (debugElement.checked && obj.level === "debug") { }
                else if (infoElement.checked && obj.level === "info") { }
                else if (obj.message.toLowerCase().includes("favicon")) { }
                else {
                    const preElement = document.createElement("pre")
                    let text = ""
                    if (prettifyElement.checked) {
                        text = `${obj.timestampISO} >> ${obj.level} >> ${obj.group} >> ${obj.message} >> ${JSON.stringify(obj.obj, true, 2)}`
                    } else {
                        text = `${obj.timestampISO} >> ${obj.level} >> ${obj.group} >> ${obj.message} >> ${JSON.stringify(obj.obj)}`
                    }
                    preElement.innerText = text
                    logElement.appendChild(preElement)
                }
            }
            split.forEach(line => {
            })
        }

        async function pullLogs() {
            const files = await getJSON("/api/logger/files-available")
            await loadLogs(files)
        }

    </script>
    <script type="module">
        const password = prompt("Enter the admin password", "admin")
        const loginResponse = await login("admin", password)
        if (loginResponse.startsWith("error")) alert("login failed. reload and try again")

        const files = await getJSON("/api/logger/files-available")
        await loadLogs(files)
        setInterval(async () => await loadLogs(files), 10_000);
    </script>
</head>

<body>
    <header>
        <p>
            <a href="/">â†ª Return Home</a>
        </p>

        <h2>
            Logs
            <div
                style="display: flex; flex-wrap: wrap; align-items: center; gap: .5rem; white-space: nowrap; font-size: 1rem;">
                Pulled every 10 sec
            </div>
        </h2>

        <div style="display: flex; flex-wrap: wrap; gap: 2rem;">
            <button onclick="pullLogs()">pull-logs</button>
            <button onclick="getJSON('/api/logger/delete-all-logs'); location.reload()">delete-all-logs</button>
            <label style="display: flex; flex-wrap: wrap; align-items: center; gap: .5rem; white-space: nowrap;">
                <input type="checkbox" id="prettify" onclick="pullLogs()">
                prettify-json
            </label>
            <label style="display: flex; flex-wrap: wrap; align-items: center; gap: .5rem;">
                <input type="checkbox" id="debug" onclick="pullLogs()">
                hide-debug
            </label>
            <label style="display: flex; flex-wrap: wrap; align-items: center; gap: .5rem;">
                <input type="checkbox" id="info" onclick="pullLogs()">
                hide-info
            </label>
            <label style="display: flex; flex-wrap: wrap; align-items: center; gap: .5rem;">
                <input type="text" name="filter" id="filter" placeholder="filter..." oninput="pullLogs()">
            </label>
        </div>
        <br>

        <span>timestampISO >> group >> level >> message >> obj</span>
        <br><br>
    </header>
    <main>
        <div id="logs"></div>
    </main>

</body>

</html>